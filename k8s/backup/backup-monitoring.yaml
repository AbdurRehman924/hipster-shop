apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: velero-metrics
  namespace: monitoring
  labels:
    app: velero
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: velero
  namespaceSelector:
    matchNames:
    - velero
  endpoints:
  - port: http-monitoring
    interval: 30s
    path: /metrics
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: velero-backup-alerts
  namespace: monitoring
  labels:
    app: velero
spec:
  groups:
  - name: velero.backup
    rules:
    - alert: VeleroBackupFailure
      expr: velero_backup_failure_total > 0
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: "Velero backup has failed"
        description: "Backup {{ $labels.schedule }} has failed. Check Velero logs."
    
    - alert: VeleroBackupMissing
      expr: time() - velero_backup_last_successful_timestamp > 86400
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Velero backup is overdue"
        description: "No successful backup in the last 24 hours for schedule {{ $labels.schedule }}"
    
    - alert: VeleroRestoreFailure
      expr: velero_restore_failure_total > 0
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: "Velero restore has failed"
        description: "Restore operation has failed. Check Velero logs immediately."
    
    - alert: VeleroBackupStorageError
      expr: velero_backup_storage_error_total > 0
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: "Velero backup storage error"
        description: "Error accessing backup storage. Check DigitalOcean Spaces connectivity."
