---
# Default deny all ingress traffic
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: hipster-shop
spec:
  podSelector: {}
  policyTypes:
  - Ingress

---
# Allow frontend to receive external traffic
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: frontend-allow-external
  namespace: hipster-shop
spec:
  podSelector:
    matchLabels:
      app: frontend
  policyTypes:
  - Ingress
  ingress:
  - from: []
    ports:
    - protocol: TCP
      port: 8080

---
# Allow frontend to call backend services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: frontend-allow-backend
  namespace: hipster-shop
spec:
  podSelector:
    matchLabels:
      app: frontend
  policyTypes:
  - Egress
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: productcatalogservice
    - podSelector:
        matchLabels:
          app: currencyservice
    - podSelector:
        matchLabels:
          app: cartservice
    - podSelector:
        matchLabels:
          app: recommendationservice
    - podSelector:
        matchLabels:
          app: checkoutservice
    - podSelector:
        matchLabels:
          app: adservice
    - podSelector:
        matchLabels:
          app: shippingservice
    ports:
    - protocol: TCP
      port: 7070
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 5050
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53

---
# Allow cartservice to access redis
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: cartservice-allow-redis
  namespace: hipster-shop
spec:
  podSelector:
    matchLabels:
      app: cartservice
  policyTypes:
  - Egress
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: redis-cart
    ports:
    - protocol: TCP
      port: 6379
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53

---
# Allow redis to receive from cartservice
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-allow-cartservice
  namespace: hipster-shop
spec:
  podSelector:
    matchLabels:
      app: redis-cart
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: cartservice
    ports:
    - protocol: TCP
      port: 6379

---
# Allow checkoutservice to call payment, shipping, email, currency, cart
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: checkoutservice-allow-backend
  namespace: hipster-shop
spec:
  podSelector:
    matchLabels:
      app: checkoutservice
  policyTypes:
  - Egress
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: paymentservice
    - podSelector:
        matchLabels:
          app: shippingservice
    - podSelector:
        matchLabels:
          app: emailservice
    - podSelector:
        matchLabels:
          app: currencyservice
    - podSelector:
        matchLabels:
          app: cartservice
    - podSelector:
        matchLabels:
          app: productcatalogservice
    ports:
    - protocol: TCP
      port: 50051
    - protocol: TCP
      port: 7070
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 5000
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53

---
# Allow backend services to receive from frontend and checkout
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: backend-services-allow-ingress
  namespace: hipster-shop
spec:
  podSelector:
    matchExpressions:
    - key: app
      operator: In
      values:
      - productcatalogservice
      - currencyservice
      - recommendationservice
      - adservice
      - shippingservice
      - paymentservice
      - emailservice
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: frontend
    - podSelector:
        matchLabels:
          app: checkoutservice
    - podSelector:
        matchLabels:
          app: recommendationservice
    ports:
    - protocol: TCP
      port: 7070
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 50051
    - protocol: TCP
      port: 5000
