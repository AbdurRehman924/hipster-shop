apiVersion: v1
kind: ConfigMap
metadata:
  name: trivy-operator-config
  namespace: trivy-system
data:
  trivy.repository: "ghcr.io/aquasecurity/trivy"
  trivy.tag: "0.50.1"
  trivy.severity: "CRITICAL,HIGH,MEDIUM"
  trivy.slow: "true"
  trivy.dbRepository: "ghcr.io/aquasecurity/trivy-db"
  trivy.javaDbRepository: "ghcr.io/aquasecurity/trivy-java-db"
  vulnerabilityReports.scanner: "Trivy"
  configAuditReports.scanner: "Trivy"
  compliance.failEntriesLimit: "10"
  report.recordFailedChecksOnly: "true"
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: trivy-scan-scheduler
  namespace: trivy-system
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: trivy-operator
          containers:
          - name: trivy-scanner
            image: aquasec/trivy:0.50.1
            command:
            - /bin/sh
            - -c
            - |
              kubectl get deployments -A -o json | \
              jq -r '.items[] | select(.metadata.namespace | test("hipster-shop|monitoring")) | "\(.metadata.namespace)/\(.metadata.name)"' | \
              while read deployment; do
                echo "Scanning $deployment"
                kubectl annotate deployment $deployment trivy.scan/last-scan=$(date -Iseconds) --overwrite
              done
          restartPolicy: OnFailure
